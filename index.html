import React, { useState, useEffect } from 'react';
import { ArrowRight, Star, Trophy } from 'lucide-react';

const EdoardoGame = () => {
  const [stage, setStage] = useState(0);
  const [score, setScore] = useState(0);
  const [gameStarted, setGameStarted] = useState(false);
  const [miniGameActive, setMiniGameActive] = useState(false);
  const [miniGameComplete, setMiniGameComplete] = useState(false);
  
  // Mini-game states
  const [catchGame, setCatchGame] = useState({ items: [], caught: 0, target: 8 });
  const [whackGame, setWhackGame] = useState({ moles: [], score: 0, target: 15 });
  const [tetrisGame, setTetrisGame] = useState({ 
    board: Array(12).fill(null).map(() => Array(8).fill(0)),
    currentPiece: null,
    pieceX: 3,
    pieceY: 0,
    linesCleared: 0,
    target: 3
  });

  const stages = [
    {
      title: "CHAPTER 1: THE ORIGIN",
      subtitle: "Italy â†’ UK ğŸ­",
      description: "Our story begins in Milan! Edoardo grew up in a big Italian family â€” mum, dad, a younger brother Ricky (Gen Z alert), and a whopping 14 cousins. Sunday lunches were harder to escape than the final boss of Super Mario.",
      skills: ["Drama Studies", "Cultural Adaptation", "Creative Performance"],
      color: "#00ff00",
      miniGame: "catch",
      miniGameInstructions: "Catch 8 falling pizzas! ğŸ• Click or use arrow keys!",
      image: "duomo"
    },
    {
      title: "CHAPTER 2: THE SHIFT",
      subtitle: "Hospitality â†’ Digital (Pre-COVID)",
      description: "Working in hospitality, then pivoting to digital marketing and e-commerce before COVID changed everything. A bold career transformation!",
      skills: ["Career Transition", "Digital Marketing", "Resilience"],
      color: "#00ffff",
      miniGame: "whack",
      miniGameInstructions: "Whack 15 moles! Click the moles before they disappear!",
      image: "lanyard"
    },
    {
      title: "CHAPTER 3: THE GROWTH",
      subtitle: "Diageo - Present Day ğŸš€",
      description: "End to End Marketing Manager at Diageo One - mastering customer journeys, data-driven decisions, and building loyalty programs for world-class spirits brands!",
      skills: ["Customer Journeys", "Data-Driven Strategy", "Marketing Leadership"],
      color: "#ff00ff",
      miniGame: "tetris",
      miniGameInstructions: "Clear 3 lines in Tetris! Arrow keys to move/rotate!",
      image: "fishing"
    }
  ];

  const currentStage = stages[stage];

  // Image URLs - replace with your actual image URLs
  const images = {
    duomo: 'YOUR_DUOMO_IMAGE_URL',
    lanyard: 'YOUR_LANYARD_IMAGE_URL',
    fishing: 'YOUR_FISHING_IMAGE_URL',
    face: 'YOUR_FACE_IMAGE_URL' // For whack-a-mole
  };

  // CATCH GAME LOGIC
  const initCatchGame = () => {
    setCatchGame({ items: [], caught: 0, target: 8 });
  };

  useEffect(() => {
    if (miniGameActive && currentStage.miniGame === 'catch') {
      const interval = setInterval(() => {
        if (catchGame.caught < catchGame.target) {
          setCatchGame(prev => ({
            ...prev,
            items: [...prev.items, { id: Date.now() + Math.random(), x: Math.random() * 80 + 10, y: 0 }]
          }));
        }
      }, 1200);
      return () => clearInterval(interval);
    }
  }, [miniGameActive, catchGame.caught, currentStage.miniGame]);

  useEffect(() => {
    if (miniGameActive && currentStage.miniGame === 'catch') {
      const interval = setInterval(() => {
        setCatchGame(prev => ({
          ...prev,
          items: prev.items.map(item => ({ ...item, y: item.y + 2.5 })).filter(item => item.y < 100)
        }));
      }, 50);
      return () => clearInterval(interval);
    }
  }, [miniGameActive, currentStage.miniGame]);

  const catchItem = (id) => {
    setCatchGame(prev => {
      const newCaught = prev.caught + 1;
      if (newCaught >= prev.target) {
        completeMiniGame();
      }
      return {
        ...prev,
        items: prev.items.filter(item => item.id !== id),
        caught: newCaught
      };
    });
  };

  // WHACK-A-MOLE GAME LOGIC
  const initWhackGame = () => {
    setWhackGame({ moles: [], score: 0, target: 15 });
  };

  useEffect(() => {
    if (miniGameActive && currentStage.miniGame === 'whack') {
      const interval = setInterval(() => {
        if (whackGame.score < whackGame.target) {
          const position = Math.floor(Math.random() * 9);
          setWhackGame(prev => ({
            ...prev,
            moles: [...prev.moles, { id: Date.now(), position, visible: true }]
          }));

          setTimeout(() => {
            setWhackGame(prev => ({
              ...prev,
              moles: prev.moles.filter(m => m.id !== Date.now())
            }));
          }, 1500);
        }
      }, 800);
      return () => clearInterval(interval);
    }
  }, [miniGameActive, whackGame.score, currentStage.miniGame]);

  const whackMole = (id) => {
    setWhackGame(prev => {
      const newScore = prev.score + 1;
      if (newScore >= prev.target) {
        completeMiniGame();
      }
      return {
        ...prev,
        moles: prev.moles.filter(m => m.id !== id),
        score: newScore
      };
    });
  };

  // TETRIS GAME LOGIC
  const tetrisPieces = [
    [[1,1,1,1]], // I
    [[1,1],[1,1]], // O
    [[1,1,1],[0,1,0]], // T
    [[1,1,0],[0,1,1]], // S
    [[0,1,1],[1,1,0]], // Z
    [[1,1,1],[1,0,0]], // L
    [[1,1,1],[0,0,1]], // J
  ];

  const initTetrisGame = () => {
    const newPiece = tetrisPieces[Math.floor(Math.random() * tetrisPieces.length)];
    setTetrisGame({
      board: Array(12).fill(null).map(() => Array(8).fill(0)),
      currentPiece: newPiece,
      pieceX: 3,
      pieceY: 0,
      linesCleared: 0,
      target: 3
    });
  };

  useEffect(() => {
    if (miniGameActive && currentStage.miniGame === 'tetris' && tetrisGame.currentPiece) {
      const interval = setInterval(() => {
        moveTetrisPiece('down');
      }, 600);
      return () => clearInterval(interval);
    }
  }, [miniGameActive, currentStage.miniGame, tetrisGame]);

  useEffect(() => {
    if (miniGameActive && currentStage.miniGame === 'tetris') {
      const handleTetrisKey = (e) => {
        if (e.key === 'ArrowLeft') moveTetrisPiece('left');
        if (e.key === 'ArrowRight') moveTetrisPiece('right');
        if (e.key === 'ArrowDown') moveTetrisPiece('down');
        if (e.key === 'ArrowUp') rotateTetrisPiece();
      };
      window.addEventListener('keydown', handleTetrisKey);
      return () => window.removeEventListener('keydown', handleTetrisKey);
    }
  }, [miniGameActive, currentStage.miniGame, tetrisGame]);

  const canMovePiece = (newX, newY, piece = tetrisGame.currentPiece) => {
    for (let y = 0; y < piece.length; y++) {
      for (let x = 0; x < piece[y].length; x++) {
        if (piece[y][x]) {
          const boardX = newX + x;
          const boardY = newY + y;
          if (boardX < 0 || boardX >= 8 || boardY >= 12) return false;
          if (boardY >= 0 && tetrisGame.board[boardY][boardX]) return false;
        }
      }
    }
    return true;
  };

  const moveTetrisPiece = (direction) => {
    let newX = tetrisGame.pieceX;
    let newY = tetrisGame.pieceY;

    if (direction === 'left') newX--;
    if (direction === 'right') newX++;
    if (direction === 'down') newY++;

    if (canMovePiece(newX, newY)) {
      setTetrisGame(prev => ({ ...prev, pieceX: newX, pieceY: newY }));
    } else if (direction === 'down') {
      lockPiece();
    }
  };

  const rotateTetrisPiece = () => {
    const rotated = tetrisGame.currentPiece[0].map((_, i) =>
      tetrisGame.currentPiece.map(row => row[i]).reverse()
    );
    if (canMovePiece(tetrisGame.pieceX, tetrisGame.pieceY, rotated)) {
      setTetrisGame(prev => ({ ...prev, currentPiece: rotated }));
    }
  };

  const lockPiece = () => {
    const newBoard = tetrisGame.board.map(row => [...row]);
    tetrisGame.currentPiece.forEach((row, y) => {
      row.forEach((cell, x) => {
        if (cell) {
          const boardY = tetrisGame.pieceY + y;
          const boardX = tetrisGame.pieceX + x;
          if (boardY >= 0 && boardY < 12 && boardX >= 0 && boardX < 8) {
            newBoard[boardY][boardX] = 1;
          }
        }
      });
    });

    let linesCleared = 0;
    const clearedBoard = newBoard.filter(row => {
      if (row.every(cell => cell === 1)) {
        linesCleared++;
        return false;
      }
      return true;
    });

    while (clearedBoard.length < 12) {
      clearedBoard.unshift(Array(8).fill(0));
    }

    const newLinesCleared = tetrisGame.linesCleared + linesCleared;

    if (newLinesCleared >= tetrisGame.target) {
      completeMiniGame();
      return;
    }

    const newPiece = tetrisPieces[Math.floor(Math.random() * tetrisPieces.length)];
    setTetrisGame({
      board: clearedBoard,
      currentPiece: newPiece,
      pieceX: 3,
      pieceY: 0,
      linesCleared: newLinesCleared,
      target: tetrisGame.target
    });
  };

  const startMiniGame = () => {
    setMiniGameActive(true);
    setMiniGameComplete(false);
    
    switch (currentStage.miniGame) {
      case 'catch': initCatchGame(); break;
      case 'whack': initWhackGame(); break;
      case 'tetris': initTetrisGame(); break;
    }
  };

  const completeMiniGame = () => {
    setMiniGameComplete(true);
    setScore(score + 1000);
    setTimeout(() => {
      setMiniGameActive(false);
    }, 1000);
  };

  const nextStage = () => {
    if (stage < stages.length - 1) {
      setStage(stage + 1);
      setMiniGameComplete(false);
    }
  };

  const startGame = () => {
    setGameStarted(true);
    setStage(0);
    setScore(0);
  };

  if (!gameStarted) {
    return (
      <div className="w-full h-screen bg-black flex items-center justify-center p-4 font-mono overflow-auto">
        <div className="text-center max-w-2xl">
          <div className="mb-8 text-6xl animate-pulse">ğŸ®</div>
          <h1 className="text-5xl font-bold mb-4 text-green-400" style={{textShadow: '4px 4px 0 #000'}}>
            MEET EDOARDO
          </h1>
          <h2 className="text-2xl mb-8 text-cyan-400">THE RETRO QUEST</h2>
          <div className="bg-purple-900 border-4 border-purple-400 p-6 mb-8">
            <p className="text-white text-lg mb-4">
              Play through 3 chapters of Edoardo's journey from Italy to Diageo!
            </p>
            <div className="text-yellow-300 text-sm">
              <p>ğŸ• Chapter 1: Catch Pizzas</p>
              <p>ğŸ”¨ Chapter 2: Whack-a-Mole</p>
              <p>ğŸ® Chapter 3: Tetris Challenge</p>
            </div>
          </div>
          <button
            onClick={startGame}
            className="bg-green-500 hover:bg-green-600 text-black font-bold text-2xl px-12 py-4 border-4 border-green-300"
          >
            PRESS START
          </button>
        </div>
      </div>
    );
  }

  return (
    <div className="w-full h-screen bg-black overflow-hidden font-mono">
      <div className="absolute inset-0 pointer-events-none" 
           style={{
             background: 'repeating-linear-gradient(0deg, rgba(0,0,0,0.15), rgba(0,0,0,0.15) 1px, transparent 1px, transparent 2px)',
             zIndex: 50
           }}
      />
      
      <div className="absolute top-4 left-4 text-yellow-300 text-2xl z-10 bg-black bg-opacity-70 px-4 py-2 border-2 border-yellow-300">
        SCORE: {score.toString().padStart(6, '0')}
      </div>

      <div className="absolute top-4 right-4 text-cyan-300 text-2xl z-10 bg-black bg-opacity-70 px-4 py-2 border-2 border-cyan-300">
        CHAPTER {stage + 1}/3
      </div>

      {!miniGameActive && !miniGameComplete && (
        <div className="w-full h-full flex flex-col items-center justify-center p-8 overflow-auto">
          <div 
            className="text-4xl font-bold mb-2 text-center"
            style={{color: currentStage.color, textShadow: '4px 4px 0 #000'}}
          >
            {currentStage.title}
          </div>
          
          <div className="text-xl mb-8 text-white text-center" style={{textShadow: '2px 2px 0 #000'}}>
            {currentStage.subtitle}
          </div>

          <div 
            className="max-w-3xl w-full border-4 p-6 mb-8 bg-opacity-90"
            style={{
              borderColor: currentStage.color,
              backgroundColor: '#1a1a2e',
              boxShadow: `0 0 20px ${currentStage.color}40`
            }}
          >
            <p className="text-white text-xl mb-6 text-center">
              ğŸ”’ <strong>LOCKED</strong> ğŸ”’
            </p>
            <p className="text-gray-400 text-center mb-4">
              Complete the mini-game to unlock this chapter!
            </p>
            <p className="text-cyan-400 text-center text-sm">
              {currentStage.miniGameInstructions}
            </p>
          </div>

          <button
            onClick={startMiniGame}
            className="bg-green-500 hover:bg-green-600 text-black font-bold text-2xl px-12 py-4 border-4 border-green-300 animate-pulse"
          >
            START MINI-GAME
          </button>
        </div>
      )}

      {miniGameActive && currentStage.miniGame === 'catch' && (
        <div className="w-full h-full flex flex-col items-center justify-center p-8">
          <h3 className="text-3xl text-white mb-4">Catch the Pizzas! ğŸ•</h3>
          <p className="text-xl text-green-400 mb-4">Caught: {catchGame.caught}/{catchGame.target}</p>
          <div className="relative w-full max-w-2xl h-96 border-4 border-green-500 bg-gray-900 overflow-hidden">
            {catchGame.items.map(item => (
              <div
                key={item.id}
                onClick={() => catchItem(item.id)}
                className="absolute text-4xl cursor-pointer hover:scale-125 transition-transform"
                style={{ left: `${item.x}%`, top: `${item.y}%` }}
              >
                ğŸ•
              </div>
            ))}
            <div className="absolute bottom-4 left-1/2 transform -translate-x-1/2 text-5xl">
              ğŸ‘¨â€ğŸ³
            </div>
          </div>
        </div>
      )}

      {miniGameActive && currentStage.miniGame === 'whack' && (
        <div className="w-full h-full flex flex-col items-center justify-center p-8">
          <h3 className="text-3xl text-white mb-4">Whack-a-Mole! ğŸ”¨</h3>
          <p className="text-xl text-cyan-400 mb-4">Score: {whackGame.score}/{whackGame.target}</p>
          <div className="grid grid-cols-3 gap-4 max-w-md">
            {Array.from({ length: 9 }, (_, i) => {
              const mole = whackGame.moles.find(m => m.position === i && m.visible);
              return (
                <div
                  key={i}
                  onClick={() => mole && whackMole(mole.id)}
                  className="w-24 h-24 border-4 border-cyan-500 bg-brown-800 rounded-full flex items-center justify-center cursor-pointer hover:bg-brown-700 overflow-hidden"
                  style={{backgroundColor: '#654321'}}
                >
                  {mole ? (
                    images.face ? (
                      <img 
                        src={images.face} 
                        alt="Whack Edoardo" 
                        className="w-full h-full object-cover"
                        style={{imageRendering: 'pixelated', filter: 'contrast(1.2)'}}
                      />
                    ) : (
                      <span className="text-4xl">ğŸ˜„</span>
                    )
                  ) : (
                    <span className="text-4xl">ğŸ•³ï¸</span>
                  )}
                </div>
              );
            })}
          </div>
        </div>
      )}

      {miniGameActive && currentStage.miniGame === 'tetris' && (
        <div className="w-full h-full flex flex-col items-center justify-center p-8">
          <h3 className="text-3xl text-white mb-4">Tetris Challenge! ğŸ®</h3>
          <p className="text-xl text-pink-400 mb-4">Lines: {tetrisGame.linesCleared}/{tetrisGame.target}</p>
          <p className="text-sm text-gray-400 mb-2">Arrow Keys: â† â†’ â†“ â†‘(rotate)</p>
          <div className="border-4 border-pink-500 bg-black p-2">
            {tetrisGame.board.map((row, y) => (
              <div key={y} className="flex">
                {row.map((cell, x) => {
                  let isCurrentPiece = false;
                  if (tetrisGame.currentPiece) {
                    tetrisGame.currentPiece.forEach((pieceRow, py) => {
                      pieceRow.forEach((pieceCell, px) => {
                        if (pieceCell && 
                            tetrisGame.pieceY + py === y && 
                            tetrisGame.pieceX + px === x) {
                          isCurrentPiece = true;
                        }
                      });
                    });
                  }
                  
                  return (
                    <div
                      key={x}
                      className="w-6 h-6 border border-gray-700"
                      style={{
                        backgroundColor: isCurrentPiece ? '#ff00ff' : (cell ? '#00ff00' : '#000')
                      }}
                    />
                  );
                })}
              </div>
            ))}
          </div>
        </div>
      )}

      {miniGameComplete && !miniGameActive && (
        <div className="w-full h-full flex flex-col items-center justify-center p-8 overflow-auto">
          <div 
            className="text-4xl font-bold mb-2 text-center animate-pulse"
            style={{color: currentStage.color, textShadow: '4px 4px 0 #000'}}
          >
            âœ¨ UNLOCKED! âœ¨
          </div>
          
          <div 
            className="text-3xl font-bold mb-2 text-center"
            style={{color: currentStage.color, textShadow: '4px 4px 0 #000'}}
          >
            {currentStage.title}
          </div>
          
          <div className="text-xl mb-6 text-white text-center" style={{textShadow: '2px 2px 0 #000'}}>
            {currentStage.subtitle}
          </div>

          {/* Personal Photo */}
          <div className="mb-6 border-4 border-white p-2 bg-gray-900">
            {stage === 0 && images.duomo && (
              <img src={images.duomo} alt="Milan Duomo" className="w-64 h-64 object-cover" />
            )}
            {stage === 1 && images.lanyard && (
              <img src={images.lanyard} alt="Diageo Lanyard" className="w-64 h-64 object-cover" />
            )}
            {stage === 2 && images.fishing && (
              <img src={images.fishing} alt="Fishing in Norway" className="w-64 h-64 object-cover" />
            )}
            {!((stage === 0 && images.duomo) || (stage === 1 && images.lanyard) || (stage === 2 && images.fishing)) && (
              <div className="w-64 h-64 bg-gray-800 flex items-center justify-center text-6xl">
                {stage === 0 && 'ğŸ›ï¸'}
                {stage === 1 && 'ğŸ­'}
                {stage === 2 && 'ğŸ£'}
              </div>
            )}
            <p className="text-center text-gray-400 text-sm mt-2">
              {stage === 0 && 'Milan Duomo - Italian roots'}
              {stage === 1 && 'Career transition era'}
              {stage === 2 && 'Work-life balance at Diageo'}
            </p>
          </div>

          <div 
            className="max-w-3xl w-full border-4 p-6 mb-8 bg-opacity-90 relative"
            style={{
              borderColor: currentStage.color,
              backgroundColor: '#1a1a2e',
              boxShadow: `0 0 20px ${currentStage.color}40`
            }}
          >
            <p className="text-white text-lg leading-relaxed mb-6">
              {currentStage.description}
            </p>

            <div className="flex flex-wrap gap-3 justify-center">
              {currentStage.skills.map((skill, idx) => (
                <div
                  key={idx}
                  className="px-4 py-2 border-2 font-bold text-sm flex items-center gap-2"
                  style={{
                    backgroundColor: currentStage.color + '20',
                    borderColor: currentStage.color,
                    color: currentStage.color
                  }}
                >
                  <Star size={16} fill={currentStage.color} />
                  {skill}
                </div>
              ))}
            </div>
          </div>

          {stage < stages.length - 1 ? (
            <button
              onClick={nextStage}
              className="bg-green-500 hover:bg-green-600 text-black font-bold text-2xl px-12 py-4 border-4 border-green-300 flex items-center gap-2"
            >
              NEXT CHAPTER <ArrowRight />
            </button>
          ) : (
            <div className="text-center">
              <div className="text-6xl mb-4 animate-bounce">ğŸ†</div>
              <p className="text-green-400 text-3xl font-bold mb-2">GAME COMPLETE!</p>
              <p className="text-white text-xl mt-2">You've discovered Edoardo's journey!</p>
              <p className="text-cyan-400 text-lg mt-4">ğŸš€ Ready to collaborate and innovate together! ğŸš€</p>
              <p className="text-pink-400 text-md mt-2">Let's build something amazing! ğŸ’ª</p>
            </div>
          )}
        </div>
      )}
    </div>
  );
};

export default EdoardoGame;
